@{
    ViewData["Title"] = "Đặt món bằng QR";
}

<div class="container mt-4">
    <h3 class="mb-3">@ViewData["Title"]</h3>
    <div class="alert alert-light border d-flex align-items-center" role="alert">
        <div>
            <div class="fw-semibold">Cách hoạt động</div>
            <div class="small text-muted">QR được nhà hàng dán trên bàn. Khách quét QR để mở trang này với mã bàn tự điền. Bạn cũng có thể nhập mã bàn thủ công dưới đây.</div>
        </div>
    </div>
    <div class="row g-3">
        <div class="col-md-4">
            <label class="form-label">Mã bàn (Table Code)</label>
            <input id="tableCode" class="form-control" placeholder="VD: T01" />
            <div class="mt-3">
                <div class="small text-muted mb-1">QR truy cập (chia sẻ đường dẫn này)</div>
                <div id="qrShare" class="border bg-white rounded p-2 d-inline-block"></div>
            </div>
        </div>
        <div class="col-md-8">
            <label class="form-label">Chọn món</label>
            <div class="row g-2 align-items-center">
                <div class="col-md-7">
                    <select id="productSelect" class="form-select"></select>
                </div>
                <div class="col-md-3">
                    <input id="qtyInput" type="number" class="form-control" min="1" value="1" />
                </div>
                <div class="col-md-2 d-grid">
                    <button id="addItem" class="btn btn-outline-primary" type="button">Thêm</button>
                </div>
            </div>
            <ul id="cart" class="list-group mt-2"></ul>
        </div>
    </div>
    <div class="row g-3 mt-3">
        <div class="col-md-6">
            <label class="form-label">Chọn tối đa 2 voucher</label>
            <div id="voucherList" class="border rounded p-2" style="max-height:220px; overflow:auto;"></div>
            <small class="text-muted">Hiển thị thời gian còn lại và số lượt đã dùng.</small>
        </div>
        <div class="col-md-6">
            <div class="d-flex gap-2 mt-md-4">
                <button id="btnSend" class="btn btn-brand-primary">Gửi đơn</button>
                <button id="btnPreview" class="btn btn-outline-secondary" type="button">Xem tạm tính</button>
            </div>
            <div class="mt-3" id="result"></div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
function getQueryParam(name){
    const params = new URLSearchParams(window.location.search);
    return params.get(name) || '';
}

document.getElementById('btnSend').addEventListener('click', async () => {
    const tableCode = document.getElementById('tableCode').value;
    let items = window.__cart || [];
    const voucherIds = getSelectedVoucherIds();
    const res = await fetch('/Order/FromQr', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tableCode, items, voucherIds })
    });
    const data = await res.json();
    document.getElementById('result').innerText = 'Đã tạo đơn #' + (data.orderId ?? '');
});

document.getElementById('btnPreview').addEventListener('click', async () => {
    const tableCode = document.getElementById('tableCode').value;
    let items = window.__cart || [];
    const voucherIds = getSelectedVoucherIds();
    const res = await fetch('/Order/Preview', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tableCode, items, voucherIds })
    });
    const data = await res.json();
    const combos = (data.combos || []).map(c => `${c.comboName}: -${(c.discountAmount||0).toLocaleString()}`).join('\n');
    const vline = `Voucher: -${(data.voucherDiscount||0).toLocaleString()}`;
    document.getElementById('result').innerText = `Tạm tính: ${data.subtotal.toLocaleString()}\nGiảm combo: ${data.discount.toLocaleString()}\n${vline}\nTổng: ${data.total.toLocaleString()}\n${combos}`;
});

async function loadProducts() {
    const res = await fetch('/api/products');
    const data = await res.json();
    const sel = document.getElementById('productSelect');
    sel.innerHTML = '';
    window.__productMap = {};
    data.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id; opt.innerHTML = `${p.name} — <span style='color:#da291c'>${p.price.toLocaleString()}đ</span>`;
        sel.appendChild(opt);
        window.__productMap[p.id] = p;
    });
}

window.__cart = [];
document.getElementById('addItem').addEventListener('click', () => {
    const pid = parseInt(document.getElementById('productSelect').value, 10) || 0;
    const qty = parseInt(document.getElementById('qtyInput').value, 10) || 1;
    if (!pid || qty <= 0) return;
    const p = window.__productMap[pid] || { name: `Product ${pid}`, price: 0 };
    window.__cart.push({ productId: pid, quantity: qty, name: p.name, price: p.price });
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    const total = (p.price * qty) || 0;
    li.innerHTML = `<span>${p.name} x <strong>${qty}</strong></span><span class='fw-bold' style='color:#da291c'>${total.toLocaleString()}đ</span>`;
    document.getElementById('cart').appendChild(li);
});

// Prefill table code from URL and render a small QR to share the link
const host = window.location.origin;
const initialCode = getQueryParam('tableCode');
if (initialCode) {
    document.getElementById('tableCode').value = initialCode;
}
let shareQrInstance;
function renderShareQr(){
    const code = document.getElementById('tableCode').value || '';
    const url = `${host}/Order/ScanQr?tableCode=${encodeURIComponent(code)}`;
    const el = document.getElementById('qrShare');
    el.innerHTML = '';
    shareQrInstance = new QRCode(el, { text: url, width: 120, height: 120 });
}
document.getElementById('tableCode').addEventListener('input', renderShareQr);

loadProducts();
renderShareQr();

async function loadVouchers(){
    const res = await fetch('/api/vouchers');
    const list = await res.json();
    const box = document.getElementById('voucherList');
    box.innerHTML = '';
    list.forEach(v => {
        const id = `v-${v.id}`;
        const cb = document.createElement('input'); cb.type='checkbox'; cb.id=id; cb.value=v.id; cb.className='form-check-input me-2';
        cb.addEventListener('change', enforceMaxTwo);
        const label = document.createElement('label'); label.className='form-check-label'; label.setAttribute('for', id);
        const left = v.maxUses === 0 ? '∞' : `${v.maxUses - v.used}`;
        const remain = v.remainingSeconds != null ? formatRemain(v.remainingSeconds) : '';
        label.innerText = `${v.code} (${v.percent}%)- còn: ${left}, ${remain}`;
        const row = document.createElement('div'); row.className='form-check';
        row.appendChild(cb); row.appendChild(label);
        box.appendChild(row);
    });
}

function enforceMaxTwo(){
    const cbs = Array.from(document.querySelectorAll('#voucherList input[type=checkbox]'));
    const checked = cbs.filter(x=>x.checked);
    if (checked.length > 2){
        checked[2].checked = false;
    }
}

function getSelectedVoucherIds(){
    return Array.from(document.querySelectorAll('#voucherList input[type=checkbox]:checked')).map(x=>parseInt(x.value,10));
}

function formatRemain(seconds){
    const s = Math.max(0, Math.floor(seconds));
    const d = Math.floor(s / 86400), h = Math.floor((s%86400)/3600), m = Math.floor((s%3600)/60);
    if (d>0) return `${d}d ${h}h`; if (h>0) return `${h}h ${m}m`; return `${m}m`;
}

loadVouchers();
</script>


