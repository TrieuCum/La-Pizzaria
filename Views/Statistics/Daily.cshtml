@{
    ViewData["Title"] = "Thống kê theo ngày";
    var day = (DateTime)ViewBag.Day;
}

<style>
    /* UI inspired by `giao dien/thống kê` (clean dashboard + orange accent) */
    .lp-page-title { font-weight: 900; letter-spacing: .2px; }
    .lp-muted { color: #6b7280; }
    .lp-accent { color: #f48c25; }
    .lp-card { border: 1px solid rgba(17,24,39,.08); border-radius: 14px; }
    .lp-tab { border-radius: 10px; font-weight: 800; }
    .lp-badge { border-radius: 999px; font-weight: 800; }
    .lp-soft { background: rgba(244,140,37,.10); }
    .lp-kpi { border: 1px solid rgba(17,24,39,.08); border-radius: 14px; background: #fff; }
    .lp-kpi .k { color: #6b7280; font-size: .85rem; font-weight: 800; text-transform: uppercase; letter-spacing: .04em; }
    .lp-kpi .v { font-size: 1.6rem; font-weight: 900; }
</style>

<div class="d-flex flex-wrap align-items-end justify-content-between gap-2 mb-3">
    <div>
        <div class="lp-muted small">Admin / Thống kê</div>
        <div class="h3 mb-0 lp-page-title">THỐNG KÊ</div>
        <div class="lp-muted">Theo ngày</div>
    </div>
    <div class="d-flex gap-2">
        <a class="btn btn-dark lp-tab" asp-action="Daily">Theo ngày</a>
        <a class="btn btn-outline-dark lp-tab" asp-action="Weekly">Theo tuần</a>
    </div>
</div>

<div class="card lp-card shadow-sm border-0 mb-3">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-auto">
                <label class="form-label fw-semibold mb-1">Chọn ngày</label>
                <input id="dayInput" type="date" class="form-control form-control-lg" value="@day.ToString("yyyy-MM-dd")" />
            </div>
            <div class="col-md-auto">
                <button id="btnLoad" class="btn btn-primary btn-lg px-4">Tải dữ liệu</button>
            </div>
            <div class="col-md-auto">
                <a class="btn btn-outline-secondary btn-lg" asp-action="Weekly">Xem theo tuần</a>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-3">
    <div class="col-12 col-lg-6">
        <div class="lp-kpi p-3 h-100">
            <div class="k">Ngày</div>
            <div class="d-flex align-items-center justify-content-between mt-1">
                <div class="v" id="badgeDate">-</div>
                <span class="badge lp-badge lp-soft text-dark">Daily</span>
            </div>
            <div class="lp-muted small mt-2">Chọn ngày để xem doanh thu.</div>
        </div>
    </div>
    <div class="col-12 col-lg-6">
        <div class="lp-kpi p-3 h-100">
            <div class="k">Doanh thu</div>
            <div class="d-flex align-items-center justify-content-between mt-1">
                <div class="v lp-accent" id="badgeRevenue">0đ</div>
                <span class="badge lp-badge bg-success-subtle text-success">Tổng</span>
            </div>
            <div id="result" class="lp-muted small mt-2"></div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-12">
        <div class="card lp-card shadow-sm border-0">
            <div class="card-header bg-white">
                <h5 class="mb-0 fw-semibold">Biểu đồ doanh thu</h5>
            </div>
            <div class="card-body">
                <canvas id="dayChart" height="120"></canvas>
            </div>
        </div>
    </div>
    <div class="col-12">
        <div class="card lp-card shadow-sm border-0">
            <div class="card-header bg-white">
                <h5 class="mb-0 fw-semibold">Chi tiết</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="detailTable">
                        <thead class="table-light">
                            <tr>
                                <th class="fw-semibold">Chỉ số</th>
                                <th class="fw-semibold">Giá trị</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadDay() {
    const day = document.getElementById('dayInput').value;
    const url = `/Statistics/DailyData?day=${encodeURIComponent(day)}`;
    const res = await fetch(url);
    const data = await res.json();
    const d = new Date(data.date);
    const text = `Doanh thu ngày ${d.toLocaleDateString()}: ${Number(data.revenue).toLocaleString()}đ`;
    document.getElementById('result').innerText = text;
    document.getElementById('badgeDate').innerText = d.toLocaleDateString();
    document.getElementById('badgeRevenue').innerText = Number(data.revenue).toLocaleString() + 'đ';

    // vertical details table
    const tbody = document.querySelector('#detailTable tbody');
    tbody.innerHTML = '';
    const rows = [
        { k: 'Ngày', v: d.toLocaleDateString() },
        { k: 'Tổng doanh thu', v: Number(data.revenue).toLocaleString() + 'đ' }
    ];
    rows.forEach(r => {
        const tr = document.createElement('tr');
        const td1 = document.createElement('td'); td1.textContent = r.k;
        const td2 = document.createElement('td'); td2.textContent = r.v;
        tr.appendChild(td1); tr.appendChild(td2);
        tbody.appendChild(tr);
    });

    // Simple single-bar chart
    const ctx = document.getElementById('dayChart');
    if (window.__dayChart) { window.__dayChart.destroy(); }
    window.__dayChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [d.toLocaleDateString()],
            datasets: [{ 
                label: 'Doanh thu', 
                data: [data.revenue], 
                backgroundColor: 'rgba(76, 175, 80, 0.8)',
                borderColor: 'rgba(76, 175, 80, 1)',
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false
            }]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 14, weight: '600' },
                        padding: 15
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14, weight: '600' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            return 'Doanh thu: ' + Number(context.parsed.y).toLocaleString() + 'đ';
                        }
                    }
                }
            },
            scales: { 
                y: { 
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + 'đ';
                        },
                        font: { size: 12 }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 12 }
                    }
                }
            } 
        }
    });
}
document.getElementById('btnLoad').addEventListener('click', loadDay);
loadDay();
</script>


