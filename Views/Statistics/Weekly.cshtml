@{
    ViewData["Title"] = "Thá»‘ng kÃª theo tuáº§n";
    var from = (DateTime)ViewBag.From;
}

<div class="d-flex align-items-center justify-content-between mb-4">
    <h3 class="mb-0 fw-bold">ğŸ“Š Thá»‘ng kÃª theo tuáº§n</h3>
    <div class="d-flex align-items-center gap-2">
        <a class="btn btn-sm btn-outline-dark" asp-action="Daily">Thá»‘ng kÃª theo ngÃ y</a>
        <a class="btn btn-sm btn-dark" asp-action="Weekly">Thá»‘ng kÃª theo tuáº§n</a>
    </div>
</div>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-auto">
                <label class="form-label fw-semibold mb-1">ğŸ“… Tá»« ngÃ y</label>
                <input id="fromInput" type="date" class="form-control form-control-lg" value="@from.ToString("yyyy-MM-dd")" />
            </div>
            <div class="col-md-auto">
                <label class="form-label fw-semibold mb-1">ğŸ“… Äáº¿n ngÃ y</label>
                <input id="toInput" type="date" class="form-control form-control-lg" value="@(((DateTime)ViewBag.To).ToString("yyyy-MM-dd"))" />
            </div>
            <div class="col-md-auto">
                <button id="btnLoad" class="btn btn-primary btn-lg px-4">ğŸ”„ Táº£i dá»¯ liá»‡u</button>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <div class="d-flex flex-wrap gap-3 mb-3 align-items-center">
                    <span class="badge bg-primary bg-gradient px-3 py-2 fs-6" id="badgeRange">-</span>
                    <span class="badge bg-success bg-gradient px-3 py-2 fs-6" id="badgeTotal">0Ä‘</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0 fw-semibold">ğŸ“ˆ Biá»ƒu Ä‘á»“ doanh thu theo tuáº§n</h5>
            </div>
            <div class="card-body">
                <canvas id="weekChart" height="140"></canvas>
            </div>
        </div>
    </div>
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white border-bottom">
                <h5 class="mb-0 fw-semibold">ğŸ“‹ Chi tiáº¿t doanh thu theo ngÃ y</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="detailTable">
                        <thead class="table-light">
                            <tr>
                                <th class="fw-semibold">NgÃ y</th>
                                <th class="fw-semibold">Doanh thu</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function formatDateOnly(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
}

function last7Labels(endDate) {
    const labels = [];
    for (let i = 6; i >= 0; i--) {
        const d = new Date(endDate);
        d.setDate(d.getDate() - i);
        labels.push(formatDateOnly(d));
    }
    return labels;
}

async function loadWeek() {
    const from = document.getElementById('fromInput').value;
    const to = document.getElementById('toInput').value;
    const url = `/Statistics/WeeklyData?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`;
    const res = await fetch(url);
    const payload = await res.json();
    const arr = payload.daily || [];

    const map = new Map();
    arr.forEach(x => {
        const d = new Date(x.date);
        map.set(formatDateOnly(d), Number(x.revenue));
    });
    const start = new Date(payload.from);
    const end = new Date(payload.to);
    const labels = [];
    for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
        labels.push(formatDateOnly(d));
    }
    const data = labels.map(k => map.get(k) || 0);

    // badges
    document.getElementById('badgeRange').innerText = `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;
    document.getElementById('badgeTotal').innerText = Number(payload.total || 0).toLocaleString() + 'Ä‘';

    // chart
    const ctx = document.getElementById('weekChart');
    if (window.__weekChart) { window.__weekChart.destroy(); }
    window.__weekChart = new Chart(ctx, {
        type: 'line',
        data: { 
            labels, 
            datasets: [{ 
                label: 'Doanh thu', 
                data, 
                borderColor: 'rgba(25, 118, 210, 1)',
                backgroundColor: 'rgba(25, 118, 210, 0.15)', 
                tension: 0.4, 
                fill: true,
                borderWidth: 3,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: '#1976d2',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointHoverBackgroundColor: '#1565c0',
                pointHoverBorderColor: '#fff',
                pointHoverBorderWidth: 3
            }] 
        },
        options: { 
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 14, weight: '600' },
                        padding: 15
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14, weight: '600' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            return 'Doanh thu: ' + Number(context.parsed.y).toLocaleString() + 'Ä‘';
                        }
                    }
                }
            },
            scales: { 
                y: { 
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + 'Ä‘';
                        },
                        font: { size: 12 }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 12 }
                    }
                }
            } 
        }
    });

    // vertical table per day
    const tbody = document.querySelector('#detailTable tbody');
    tbody.innerHTML = '';
    labels.forEach((lbl, i) => {
        const tr = document.createElement('tr');
        const td1 = document.createElement('td'); td1.textContent = new Date(lbl).toLocaleDateString();
        const td2 = document.createElement('td'); td2.textContent = Number(data[i]).toLocaleString() + 'Ä‘';
        tr.appendChild(td1); tr.appendChild(td2);
        tbody.appendChild(tr);
    });
}
document.getElementById('btnLoad').addEventListener('click', loadWeek);
loadWeek();
</script>


