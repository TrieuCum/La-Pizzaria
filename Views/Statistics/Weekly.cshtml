@{
    ViewData["Title"] = "Thống kê theo tuần";
    var from = (DateTime)ViewBag.From;
}

<style>
    /* UI inspired by `giao dien/thống kê` (clean dashboard + orange accent) */
    .lp-page-title { font-weight: 900; letter-spacing: .2px; }
    .lp-muted { color: #6b7280; }
    .lp-accent { color: #f48c25; }
    .lp-card { border: 1px solid rgba(17,24,39,.08); border-radius: 14px; }
    .lp-tab { border-radius: 10px; font-weight: 800; }
    .lp-badge { border-radius: 999px; font-weight: 800; }
    .lp-soft { background: rgba(244,140,37,.10); }
    .lp-kpi { border: 1px solid rgba(17,24,39,.08); border-radius: 14px; background: #fff; }
    .lp-kpi .k { color: #6b7280; font-size: .85rem; font-weight: 800; text-transform: uppercase; letter-spacing: .04em; }
    .lp-kpi .v { font-size: 1.6rem; font-weight: 900; }
</style>

<div class="d-flex flex-wrap align-items-end justify-content-between gap-2 mb-3">
    <div>
        <div class="lp-muted small">Admin / Thống kê</div>
        <div class="h3 mb-0 lp-page-title">THỐNG KÊ</div>
        <div class="lp-muted">Theo tuần</div>
    </div>
    <div class="d-flex gap-2">
        <a class="btn btn-outline-dark lp-tab" asp-action="Daily">Theo ngày</a>
        <a class="btn btn-dark lp-tab" asp-action="Weekly">Theo tuần</a>
    </div>
</div>

<div class="card lp-card shadow-sm border-0 mb-3">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-auto">
                <label class="form-label fw-semibold mb-1">Từ ngày</label>
                <input id="fromInput" type="date" class="form-control form-control-lg" value="@from.ToString("yyyy-MM-dd")" />
            </div>
            <div class="col-md-auto">
                <label class="form-label fw-semibold mb-1">Đến ngày</label>
                <input id="toInput" type="date" class="form-control form-control-lg" value="@(((DateTime)ViewBag.To).ToString("yyyy-MM-dd"))" />
            </div>
            <div class="col-md-auto">
                <button id="btnLoad" class="btn btn-primary btn-lg px-4">Tải dữ liệu</button>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-3">
    <div class="col-12 col-lg-6">
        <div class="lp-kpi p-3 h-100">
            <div class="k">Khoảng thời gian</div>
            <div class="d-flex align-items-center justify-content-between mt-1">
                <div class="v" id="badgeRange">-</div>
                <span class="badge lp-badge lp-soft text-dark">Weekly</span>
            </div>
            <div class="lp-muted small mt-2">Chọn từ ngày - đến ngày để xem xu hướng doanh thu.</div>
        </div>
    </div>
    <div class="col-12 col-lg-6">
        <div class="lp-kpi p-3 h-100">
            <div class="k">Tổng doanh thu</div>
            <div class="d-flex align-items-center justify-content-between mt-1">
                <div class="v lp-accent" id="badgeTotal">0đ</div>
                <span class="badge lp-badge bg-success-subtle text-success">Tổng</span>
            </div>
            <div class="lp-muted small mt-2">Bảng chi tiết bên dưới liệt kê theo từng ngày.</div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-12">
        <div class="card lp-card shadow-sm border-0">
            <div class="card-header bg-white">
                <h5 class="mb-0 fw-semibold">Biểu đồ doanh thu theo tuần</h5>
            </div>
            <div class="card-body">
                <canvas id="weekChart" height="140"></canvas>
            </div>
        </div>
    </div>
    <div class="col-12">
        <div class="card lp-card shadow-sm border-0">
            <div class="card-header bg-white">
                <h5 class="mb-0 fw-semibold">Chi tiết doanh thu theo ngày</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="detailTable">
                        <thead class="table-light">
                            <tr>
                                <th class="fw-semibold">Ngày</th>
                                <th class="fw-semibold">Doanh thu</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function formatDateOnly(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
}

function last7Labels(endDate) {
    const labels = [];
    for (let i = 6; i >= 0; i--) {
        const d = new Date(endDate);
        d.setDate(d.getDate() - i);
        labels.push(formatDateOnly(d));
    }
    return labels;
}

async function loadWeek() {
    const from = document.getElementById('fromInput').value;
    const to = document.getElementById('toInput').value;
    const url = `/Statistics/WeeklyData?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`;
    const res = await fetch(url);
    const payload = await res.json();
    const arr = payload.daily || [];

    const map = new Map();
    arr.forEach(x => {
        const d = new Date(x.date);
        map.set(formatDateOnly(d), Number(x.revenue));
    });
    const start = new Date(payload.from);
    const end = new Date(payload.to);
    const labels = [];
    for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
        labels.push(formatDateOnly(d));
    }
    const data = labels.map(k => map.get(k) || 0);

    // badges
    document.getElementById('badgeRange').innerText = `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;
    document.getElementById('badgeTotal').innerText = Number(payload.total || 0).toLocaleString() + 'đ';

    // chart
    const ctx = document.getElementById('weekChart');
    if (window.__weekChart) { window.__weekChart.destroy(); }
    window.__weekChart = new Chart(ctx, {
        type: 'line',
        data: { 
            labels, 
            datasets: [{ 
                label: 'Doanh thu', 
                data, 
                borderColor: 'rgba(25, 118, 210, 1)',
                backgroundColor: 'rgba(25, 118, 210, 0.15)', 
                tension: 0.4, 
                fill: true,
                borderWidth: 3,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: '#1976d2',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointHoverBackgroundColor: '#1565c0',
                pointHoverBorderColor: '#fff',
                pointHoverBorderWidth: 3
            }] 
        },
        options: { 
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { size: 14, weight: '600' },
                        padding: 15
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14, weight: '600' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            return 'Doanh thu: ' + Number(context.parsed.y).toLocaleString() + 'đ';
                        }
                    }
                }
            },
            scales: { 
                y: { 
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + 'đ';
                        },
                        font: { size: 12 }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 12 }
                    }
                }
            } 
        }
    });

    // vertical table per day
    const tbody = document.querySelector('#detailTable tbody');
    tbody.innerHTML = '';
    labels.forEach((lbl, i) => {
        const tr = document.createElement('tr');
        const td1 = document.createElement('td'); td1.textContent = new Date(lbl).toLocaleDateString();
        const td2 = document.createElement('td'); td2.textContent = Number(data[i]).toLocaleString() + 'đ';
        tr.appendChild(td1); tr.appendChild(td2);
        tbody.appendChild(tr);
    });
}
document.getElementById('btnLoad').addEventListener('click', loadWeek);
loadWeek();
</script>


