@model List<LaPizzaria.Controllers.UserViewModel>
@{ ViewData["Title"] = "Quản lý Tài khoản"; }

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>
    :root {
        --primary-red: #da291c;
        --light-cream: #f8f5ed;
        --wood-brown: #5a2e0a;
    }
    .user-banner {
        background: #ffffff;
        background-image: 
            repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.02) 10px, rgba(0,0,0,0.02) 20px);
        position: relative;
        padding: 60px 0;
        margin-bottom: 3rem;
        overflow: hidden;
    }
    .user-banner::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 20px;
        background: repeating-linear-gradient(
            90deg,
            #ff7a00 0px,
            #ff7a00 20px,
            #ffffff 20px,
            #ffffff 40px
        );
    }
    .page-title {
        font-family: 'Playfair Display', serif;
        font-weight: 900;
        font-size: clamp(36px, 6vw, 64px);
        color: #da291c;
        margin-bottom: 0.5rem;
        line-height: 1.1;
    }
    .page-subtitle {
        font-family: 'Playfair Display', serif;
        font-weight: 700;
        font-size: clamp(20px, 3vw, 28px);
        color: #5a2e0a;
    }
    .brand-card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        background: white;
        overflow: hidden;
    }
    .btn-brand-primary {
        background-color: var(--primary-red);
        border-color: var(--primary-red);
        color: white;
        font-weight: bold;
        padding: 10px 24px;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    .btn-brand-primary:hover {
        background-color: var(--wood-brown);
        border-color: var(--wood-brown);
        transform: translateY(-2px);
        color: white;
    }
    .search-pill {
        border: 2px solid #eee;
        border-radius: 10px;
        transition: all 0.3s ease;
    }
    .search-pill:focus {
        border-color: var(--primary-red);
        box-shadow: 0 0 0 4px rgba(218, 41, 28, 0.1);
    }
    .table-hover tbody tr:hover {
        background-color: var(--light-cream);
    }
    .badge-status {
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 600;
    }
    .btn-action {
        padding: 6px 12px;
        border-radius: 6px;
        transition: all 0.2s ease;
    }
</style>

<!-- Banner Section -->
<div class="user-banner">
    <div class="container position-relative" style="z-index: 1;">
        <div class="row align-items-center">
            <div class="col-lg-7">
                <h1 class="page-title">TÀI KHOẢN</h1>
                <div class="page-subtitle">
                    <span>QUẢN LÝ NGƯỜI DÙNG</span>
                </div>
            </div>
            <div class="col-lg-5 text-lg-end mt-4 mt-lg-0">
                <button type="button" class="btn btn-brand-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#userModal" onclick="openCreateModal()">
                    <i class="bi bi-plus-circle me-2"></i>Tạo tài khoản
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container mb-5">
    <!-- Toolbar -->
    <div class="brand-card p-4 mb-4">
        <form method="get" id="filterForm">
            <div class="row g-3">
                <div class="col-md-5">
                    <div class="position-relative">
                        <i class="bi bi-search position-absolute top-50 translate-middle-y text-muted" style="left: 15px;"></i>
                        <input type="text" name="search" class="form-control search-pill ps-5" placeholder="Tìm theo tên, email..." value="@Context.Request.Query["search"]">
                    </div>
                </div>
                <div class="col-md-3">
                    <select name="role" class="form-select search-pill">
                        <option value="">Tất cả vai trò</option>
                        @foreach (var r in ViewBag.AllRoles as List<string> ?? new List<string>())
                        {
                            <option value="@r" selected="@(Context.Request.Query["role"] == r)">@r</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <select name="status" class="form-select search-pill">
                        <option value="">Tất cả trạng thái</option>
                        <option value="Active" selected="@(Context.Request.Query["status"] == "Active")">Hoạt động</option>
                        <option value="Inactive" selected="@(Context.Request.Query["status"] == "Inactive")">Vô hiệu hóa</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-outline-dark w-100" style="border-radius: 10px; font-weight: 600;">
                        <i class="bi bi-funnel me-1"></i>Lọc
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Table -->
    <div class="brand-card">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead style="background-color: var(--light-cream);">
                    <tr>
                        <th class="py-3">Họ và tên</th>
                        <th>Email</th>
                        <th>Vai trò</th>
                        <th>Ngày tạo</th>
                        <th>Trạng thái</th>
                        <th class="text-center">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Any())
                    {
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td class="py-3 fw-bold">@item.User.FirstName @item.User.LastName</td>
                                <td><small class="text-muted">@item.User.Email</small></td>
                                <td>
                                    @foreach (var role in item.Roles)
                                    {
                                        <span class="badge bg-primary me-1">@role</span>
                                    }
                                    @if (!item.Roles.Any())
                                    {
                                        <span class="badge bg-secondary">User</span>
                                    }
                                </td>
                                <td>@item.User.CreatedAt.ToString("dd/MM/yyyy")</td>
                                <td>
                                    @if (item.User.IsActive)
                                    {
                                        <span class="badge bg-success badge-status">Hoạt động</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger badge-status">Vô hiệu hóa</span>
                                    }
                                </td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-outline-primary btn-action" onclick="openEditModal('@item.User.Id')" title="Sửa">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning btn-action" onclick="openResetPasswordModal('@item.User.Id', '@item.User.Email')" title="Đặt lại mật khẩu">
                                        <i class="bi bi-key"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteUser('@item.User.Id')" title="Xóa">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="text-center py-5 text-muted">
                                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                <p class="mt-2">Không có tài khoản nào</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 16px; border: none;">
            <div class="modal-header" style="background-color: var(--light-cream); border: none;">
                <h5 class="modal-title fw-bold" id="modalTitle">Tạo tài khoản</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="userForm" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-body p-4">
                    <input type="hidden" id="userId" name="id">
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Họ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="FirstName" id="firstName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Tên <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="LastName" id="lastName" required>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label fw-bold">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" name="Email" id="email" required>
                        </div>
                        <div class="col-md-12" id="passwordField">
                            <label class="form-label fw-bold">Mật khẩu <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" name="password" id="password">
                            <small class="text-muted">Tối thiểu 6 ký tự</small>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label fw-bold">Vai trò</label>
                            <div>
                                @foreach (var role in ViewBag.AllRoles as List<string> ?? new List<string>())
                                {
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input role-checkbox" type="checkbox" name="roles" value="@role" id="role_@role">
                                        <label class="form-check-label" for="role_@role">@role</label>
                                    </div>
                                }
                            </div>
                        </div>
                        <div class="col-md-12" id="statusField" style="display:none;">
                            <label class="form-label fw-bold">Trạng thái</label>
                            <select class="form-select" name="IsActive" id="isActive">
                                <option value="true">Hoạt động</option>
                                <option value="false">Vô hiệu hóa</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border: none;">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-brand-primary">Lưu</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 16px; border: none;">
            <div class="modal-header" style="background-color: var(--light-cream); border: none;">
                <h5 class="modal-title fw-bold">Đặt lại mật khẩu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="@Url.Action("ResetPassword")" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-body p-4">
                    <input type="hidden" id="resetUserId" name="id">
                    <p>Đặt lại mật khẩu cho: <strong id="resetUserEmail"></strong></p>
                    <label class="form-label fw-bold">Mật khẩu mới <span class="text-danger">*</span></label>
                    <input type="password" class="form-control" name="newPassword" required>
                    <small class="text-muted">Tối thiểu 6 ký tự</small>
                </div>
                <div class="modal-footer" style="border: none;">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-brand-primary">Đặt lại</button>
                </div>
            </form>
        </div>
    </div>
</div>

<form id="deleteForm" method="post" style="display:none;">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
<script>
function openCreateModal() {
    document.getElementById('modalTitle').textContent = 'Tạo tài khoản';
    document.getElementById('userForm').action = '@Url.Action("Create")';
    document.getElementById('userForm').reset();
    document.getElementById('userId').value = '';
    document.getElementById('email').readOnly = false;
    document.getElementById('passwordField').style.display = 'block';
    document.getElementById('password').required = true;
    document.getElementById('statusField').style.display = 'none';
    document.querySelectorAll('.role-checkbox').forEach(cb => cb.checked = false);
}

async function openEditModal(id) {
    const response = await fetch(`/UserManagement/GetUser/${id}`);
    const data = await response.json();
    
    document.getElementById('modalTitle').textContent = 'Sửa tài khoản';
    document.getElementById('userForm').action = '@Url.Action("Edit")';
    document.getElementById('userId').value = data.user.id;
    document.getElementById('firstName').value = data.user.firstName;
    document.getElementById('lastName').value = data.user.lastName;
    document.getElementById('email').value = data.user.email;
    document.getElementById('email').readOnly = true;
    document.getElementById('passwordField').style.display = 'none';
    document.getElementById('password').required = false;
    document.getElementById('statusField').style.display = 'block';
    document.getElementById('isActive').value = data.user.isActive.toString();
    
    document.querySelectorAll('.role-checkbox').forEach(cb => {
        cb.checked = data.roles.includes(cb.value);
    });
    
    new bootstrap.Modal(document.getElementById('userModal')).show();
}

function openResetPasswordModal(id, email) {
    document.getElementById('resetUserId').value = id;
    document.getElementById('resetUserEmail').textContent = email;
    new bootstrap.Modal(document.getElementById('resetPasswordModal')).show();
}

function deleteUser(id) {
    if (confirm('Bạn có chắc muốn xóa tài khoản này?')) {
        const form = document.getElementById('deleteForm');
        form.action = `/UserManagement/Delete/${id}`;
        form.submit();
    }
}
</script>
}
