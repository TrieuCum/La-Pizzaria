@using Microsoft.AspNetCore.Identity
@using LaPizzaria.Models
@model LaPizzaria.ViewModels.ProductIndexViewModel
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@{
    ViewData["Title"] = "Qu·∫£n l√Ω S·∫£n ph·∫©m";
    Layout = null;
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Pizza Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    
    <style>
        * { box-sizing: border-box; }
        body { font-size: 14px; margin: 0; padding: 0; font-family: 'Work Sans', sans-serif; background: #f8f7f5; }

        /* Unified Class Styles from User's Figma Code */
        .v17_2600 { width: 100%; min-height: 100vh; background: rgba(248,247,245,1); position: relative; overflow-x: hidden; }
        
        /* Navbar (Header) */
        .v272_48 { width: calc(100% - 256px); height: 80px; background: rgba(255,255,255,0.9); backdrop-filter: blur(8px); position: fixed; top: 0; left: 256px; z-index: 1000; border-bottom: 1px solid #f1f5f9; padding: 0 40px; display: flex; align-items: center; justify-content: space-between; }
        .v272_59 { display: flex; align-items: center; gap: 10px; text-decoration: none; color: inherit; }
        .v272_60 { color: rgba(24,20,17,1); font-weight: 900; font-size: 20px; }
        
        .header-center-nav { display: flex; gap: 32px; list-style: none; margin: 0; padding: 0; }
        .nav-item-link { color: rgba(24,20,17,1); font-weight: 600; font-size: 14px; text-decoration: none; position: relative; padding: 10px 0; }
        .nav-item-link.active { color: rgba(244,140,37,1); }
        .nav-item-link.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: rgba(244,140,37,1); }

        .header-right-actions { display: flex; align-items: center; gap: 20px; }
        .v272_73 { background: rgba(245,242,240,1); border-radius: 8px; padding: 10px 15px; display: flex; align-items: center; gap: 10px; width: 250px; }
        .v272_79 { border: none; background: transparent; color: rgba(107,114,128,1); font-size: 14px; width: 100%; outline: none; }
        
        .v272_81 { background: rgba(244,140,37,1); border-radius: 8px; padding: 10px 20px; color: white !important; font-weight: 700; text-decoration: none; display: flex; align-items: center; gap: 8px; border: none; cursor: pointer; }
        .v272_91 { position: absolute; top: -5px; right: -10px; background: rgba(244,140,37,1); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center; border: 2px solid white; font-weight: 800; }

        /* Sidebar */
        .v17_2729 { width: 256px; height: 100vh; background: rgba(255,255,255,1); position: fixed; top: 0; left: 0; z-index: 1010; border-right: 1px solid #f1f5f9; display: flex; flex-direction: column; }
        .v17_2730 { padding: 24px; display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
        .v17_2731 { width: 40px; height: 40px; background: rgba(244,140,37,1); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; }
        .v17_2735 { font-weight: 700; font-size: 18px; margin: 0; }
        .v17_2736 { font-size: 12px; color: rgba(107,114,128,1); }
        
        .sidebar-menu { flex-grow: 1; padding: 0 16px; }
        .v17_2738 { padding: 12px 16px; display: flex; align-items: center; gap: 12px; color: rgba(75,85,99,1); text-decoration: none; font-weight: 500; border-radius: 8px; transition: all 0.2s; margin-bottom: 4px; }
        .v17_2742 { background: rgba(244,140,37,0.1); color: rgba(244,140,37,1); font-weight: 600; }
        .v17_2738:hover { background: #f9fafb; color: rgba(244,140,37,1); }

        .v17_2762 { padding: 16px; border-top: 1px solid #f1f5f9; }
        .v17_2763 { background: rgba(243,244,246,1); border-radius: 8px; padding: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; color: rgba(55,65,81,1); font-weight: 700; width: 100%; border: none; cursor: pointer; }

        /* Main Content */
        .main-wrapper { padding-top: 80px; min-height: 100vh; }
        .content-container { padding: 40px; position: relative; }
        
        .v17_2603 { display: flex; flex-direction: column; margin-bottom: 40px; }
        .v17_2604 { font-weight: 900; font-size: 30px; color: rgba(24,20,17,1); margin: 0; }
        .v17_2605 { font-size: 16px; color: rgba(107,114,128,1); margin-top: 8px; }
        
        .header-action-buttons { position: absolute; top: 40px; right: 40px; display: flex; gap: 12px; }
        .v17_2606 { background: rgba(244,140,37,1); color: white !important; border-radius: 12px; padding: 12px 24px; font-weight: 700; font-size: 16px; text-decoration: none; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 12px rgba(244,140,37,0.2); transition: all 0.2s; border: none; }
        .v17_2606:hover { background: #e67a15; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(244,140,37,0.3); }
        .v17_2606_alt { background: white; color: rgba(244,140,37,1) !important; border: 2px solid rgba(244,140,37,1); border-radius: 12px; padding: 10px 22px; font-weight: 700; font-size: 16px; text-decoration: none; display: flex; align-items: center; gap: 10px; transition: all 0.2s; }
        .v17_2606_alt:hover { background: rgba(244,140,37,0.05); transform: translateY(-2px); }

        /* Search/Filter Bar */
        .v17_2610 { background: white; border-radius: 16px; padding: 10px; display: flex; align-items: center; gap: 20px; margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .v17_2768 { flex-grow: 1; background: rgba(249,250,251,1); border-radius: 12px; padding: 10px 15px; display: flex; align-items: center; gap: 10px; position: relative; }
        .v17_2769 { border: none; background: transparent; width: 100%; outline: none; font-size: 14px; padding-left: 30px; }
        
        .v17_2612 { display: flex; gap: 4px; background: rgba(249,250,251,1); border-radius: 12px; padding: 4px; }
        .cat-tab-link { padding: 8px 16px; border-radius: 8px; color: rgba(107,114,128,1); text-decoration: none; font-weight: 600; font-size: 14px; }
        .cat-tab-link.active { background: white; color: rgba(244,140,37,1); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .v17_2618 { background: rgba(249,250,251,1); border-radius: 12px; padding: 10px 16px; display: flex; align-items: center; gap: 10px; color: rgba(24,20,17,1); font-weight: 600; font-size: 14px; border: 1px solid #f1f5f9; }

        /* Table Card */
        .v17_2622 { background: white; border-radius: 16px; overflow: hidden; margin-bottom: 40px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .admin-table { width: 100%; border-collapse: collapse; }
        .v17_2625 { background: rgba(249,250,251,1); border-bottom: 1px solid #f1f5f9; }
        .admin-table th { padding: 16px 24px; text-align: left; color: rgba(107,114,128,1); font-weight: 700; font-size: 12px; text-transform: uppercase; }
        .admin-table td { padding: 16px 24px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        
        .product-img-v { width: 48px; height: 48px; border-radius: 8px; background: rgba(243,244,246,1); object-fit: cover; }
        .product-name-v { font-weight: 700; font-size: 14px; color: rgba(24,20,17,1); margin: 0; }
        .product-desc-v { font-size: 12px; color: rgba(107,114,128,1); margin: 2px 0 0; }
        
        .v17_2639 { background: rgba(254,226,226,1); color: rgba(220,38,38,1); border-radius: 9999px; padding: 2px 10px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .v17_2657 { background: rgba(220,252,231,1); color: rgba(22,163,74,1); border-radius: 9999px; padding: 2px 10px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .v17_2675 { background: rgba(244,140,37,0.2); color: rgba(244,140,37,1); border-radius: 9999px; padding: 2px 10px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        
        .v17_2643 { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .sd-green { background: rgba(34,197,94,1); box-shadow: 0 0 8px rgba(34,197,94,0.4); }
        .sd-orange { background: rgba(249,115,22,1); }
        .sd-gray { background: rgba(156,163,175,1); }

        /* Stats Section */
        .v17_2716 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-bottom: 40px; }
        .stat-box-v { border-radius: 16px; padding: 24px; display: flex; flex-direction: column; justify-content: center; min-height: 109px; position: relative; }
        .stat-box-v span { font-size: 14px; font-weight: 500; margin-bottom: 8px; }
        .stat-box-v h2 { font-weight: 900; font-size: 30px; margin: 0; color: rgba(24,20,17,1); }
        .v17_2717 { background: rgba(244,140,37,0.05); color: rgba(244,140,37,1); }
        .v17_2721 { background: rgba(240,253,244,1); color: rgba(22,163,74,1); }
        .v17_2725 { background: rgba(254,242,242,1); color: rgba(220,38,38,1); }

        /* Pagination Styles */
        .pagination-footer { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: rgba(249,250,251,1); border-top: 1px solid #f1f5f9; color: rgba(107,114,128,1); font-size: 13px; font-weight: 500; }
        .btn-pg { width: 32px; height: 32px; border-radius: 8px; border: 1px solid #e5e7eb; background: white; color: rgba(75,85,99,1); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .btn-pg:hover { background: #f9fafb; color: rgba(244,140,37,1); border-color: rgba(244,140,37,0.3); }
        .btn-pg:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Global Overwrites */
        .v272_49 { padding-top: 100px; }
    </style>
</head>
<body class="v17_2600">
    <partial name="_SidebarPartial" />

    <div class="content-wrapper">
        @* Top Header (v272_48) - This header is specific to Product Index/Admin pages *@
        <header class="v272_48" style="left: inherit; width: 100%; position: sticky;">
            <ul class="header-center-nav">
                <li><a asp-controller="Home" asp-action="Index" class="nav-item-link">Trang ch·ªß</a></li>
                <li><a asp-controller="Product" asp-action="Index" class="nav-item-link active">M√≥n ƒÉn</a></li>
                <li><a asp-controller="Voucher" asp-action="Index" class="nav-item-link">Khuy·∫øn m√£i</a></li>
                <li><a asp-controller="Order" asp-action="Index" class="nav-item-link">ƒê∆°n h√†ng c·ªßa t√¥i</a></li>
                <li><a href="#" class="nav-item-link">T√≠ch ƒëi·ªÉm</a></li>
            </ul>
            
            <div class="header-right-actions">
                <div class="v272_73">
                    <i class="bi bi-search" style="color: #94a3b8;"></i>
                    <input type="text" class="v272_79" placeholder="T√¨m ki·∫øm pizza c·ªßa b·∫°n...">
                </div>
                <a asp-controller="Account" asp-action="Manage" class="v272_81">
                    <i class="bi bi-person-fill"></i>
                    H·ªì s∆°
                </a>
                <a href="#" style="position: relative; font-size: 22px; color: #4b5563;" data-bs-toggle="offcanvas" data-bs-target="#cartOffcanvas">
                    <i class="bi bi-cart3"></i>
                    <span id="cart-count" class="v272_91" style="display: none; padding-left: 5px;">0</span>
                </a>
            </div>
        </header>

        @* Main Content *@
        <main class="main-wrapper">
        <div class="content-container">
            <div class="v17_2603">
                <h1 class="v17_2604">Qu·∫£n l√Ω S·∫£n ph·∫©m</h1>
                <p class="v17_2605">Qu·∫£n l√Ω th·ª±c ƒë∆°n v√† c√°c g√≥i combo hi·ªáu qu·∫£.</p>
                <div class="header-action-buttons">
                    <a asp-action="Upsert" class="v17_2606_alt">
                        <i class="bi bi-plus-lg"></i> Th√™m m√≥n l·∫ª
                    </a>
                    <a asp-action="CreateCombo" class="v17_2606">
                        <i class="bi bi-box-seam"></i> Th√™m combo m·ªõi
                    </a>
                </div>
            </div>

            @* Search & Tab Bar *@
            <div class="v17_2610">
                <div class="v17_2768">
                    <i class="bi bi-search" style="position: absolute; left: 15px; color: #9ca3af;"></i>
                    <input type="text" id="searchBox" class="v17_2769" placeholder="T√¨m t√™n pizza, m√£ ho·∫∑c th√†nh ph·∫ßn...">
                </div>
                <div class="v17_2612" id="catTabs">
                    <a href="#" class="cat-tab-link active" data-cat="All">T·∫•t c·∫£</a>
                    <a href="#" class="cat-tab-link" data-cat="Pizza">Pizza</a>
                    <a href="#" class="cat-tab-link" data-cat="Combo">Combo</a>
                    <a href="#" class="cat-tab-link" data-cat="M√≥n ph·ª•">M√≥n ph·ª•</a>
                </div>
                <button class="v17_2618">
                    <i class="bi bi-sliders"></i> L·ªçc th√™m
                </button>
            </div>

            @* Table Container *@
            <div class="v17_2622">
                <table class="admin-table">
                    <thead>
                        <tr class="v17_2625">
                            <th style="width: 40%;">S·∫¢N PH·∫®M</th>
                            <th>DANH M·ª§C</th>
                            <th>GI√Å</th>
                            <th>TR·∫†NG TH√ÅI</th>
                            <th class="text-end">H√ÄNH ƒê·ªòNG</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        @{
                            var outIds = Model.OutOfStockIds ?? new List<int>();
                            var pizzaCount = Model.Products.Count(p => p.Category == "Pizza" && p.IsActive && !outIds.Contains(p.Id));
                            var comboCount = Model.Combos.Count(c => c.IsActive);
                            var outCount = outIds.Count;
                        }

                        @* Products *@
                        @foreach (var p in Model.Products)
                        {
                            var isOut = outIds.Contains(p.Id);
                            var bcClass = p.Category == "Pizza" ? "v17_2675" : (p.Category == "M√≥n ph·ª•" ? "v17_2657" : "v17_2639");
                            
                            <tr data-cat="@p.Category" data-name="@p.Name">
                                <td>
                                    <div style="display: flex; align-items: center; gap: 16px;">
                                        <img src="@(string.IsNullOrEmpty(p.ImageUrl) ? "https://placehold.co/100x100?text=üçï" : p.ImageUrl)" class="product-img-v" alt="@p.Name" onerror="this.src='https://placehold.co/100x100?text=üçï'">
                                        <div>
                                            <p class="product-name-v">@p.Name</p>
                                            <p class="product-desc-v">@p.Description</p>
                                        </div>
                                    </div>
                                </td>
                                <td><span class="@bcClass">@(p.Category?.ToUpper() ?? "KH√ÅC")</span></td>
                                <td><span style="font-weight: 800; color: #1e293b;">@p.Price.ToString("N0")‚Ç´</span></td>
                                <td>
                                    <div style="display: flex; align-items: center;">
                                        <span class="v17_2643 @(isOut ? "sd-gray" : "sd-green")"></span>
                                        <span style="font-weight: 600; color: #374151;">@(isOut ? "H·∫øt h√†ng" : "C√≤n h√†ng")</span>
                                    </div>
                                </td>
                                <td class="text-end">
                                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                        <a asp-action="Upsert" asp-route-id="@p.Id" style="color: #cbd5e1; font-size: 18px;"><i class="bi bi-pencil"></i></a>
                                        <form asp-action="Delete" asp-route-id="@p.Id" method="post" class="d-inline" onsubmit="return confirm('Xo√° s·∫£n ph·∫©m n√†y?');">
                                            <button type="submit" style="background: none; border: none; color: #cbd5e1; font-size: 18px; padding: 0;"><i class="bi bi-trash"></i></button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }

                        @* Combos *@
                        @foreach (var c in Model.Combos)
                        {
                            var comboPrice = (c.Items.Select(i => ((i.Product?.Price) ?? 0m) * Math.Max(1, i.MinQuantity)).Sum() - (c.DiscountAmount > 0 ? c.DiscountAmount : 0m)) * (1 - (c.DiscountPercent ?? 0m) / 100m);
                            if (comboPrice < 0) comboPrice = 0;

                            <tr data-cat="Combo" data-name="@c.Name">
                                <td>
                                    <div style="display: flex; align-items: center; gap: 16px;">
                                        <img src="@(string.IsNullOrEmpty(c.ImageUrl) ? "https://placehold.co/100x100?text=üì¶" : c.ImageUrl)" class="product-img-v" alt="@c.Name" onerror="this.src='https://placehold.co/100x100?text=üì¶'">
                                        <div>
                                            <p class="product-name-v">@c.Name</p>
                                            <p class="product-desc-v">@string.Join(", ", c.Items.Select(i => i.Product?.Name))</p>
                                        </div>
                                    </div>
                                </td>
                                <td><span class="v17_2675">COMBO</span></td>
                                <td><span style="font-weight: 800; color: #1e293b;">@comboPrice.ToString("N0")‚Ç´</span></td>
                                <td>
                                    <div style="display: flex; align-items: center;">
                                        <span class="v17_2643 sd-green"></span>
                                        <span style="font-weight: 600; color: #374151;">C√≤n h√†ng</span>
                                    </div>
                                </td>
                                <td class="text-end">
                                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                        <a asp-action="EditCombo" asp-route-id="@c.Id" style="color: #cbd5e1; font-size: 18px;"><i class="bi bi-pencil"></i></a>
                                        <form asp-action="DeleteCombo" asp-route-id="@c.Id" method="post" class="d-inline" onsubmit="return confirm('Xo√° combo n√†y?');">
                                            <button type="submit" style="background: none; border: none; color: #cbd5e1; font-size: 18px; padding: 0;"><i class="bi bi-trash"></i></button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

                <div class="pagination-footer">
                    <div>ƒêang hi·ªÉn th·ªã <span id="visibleCount">0</span> trong t·ªïng s·ªë <span id="totalCount">0</span> s·∫£n ph·∫©m</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn-pg"><i class="bi bi-chevron-left"></i></button>
                        <button class="btn-pg"><i class="bi bi-chevron-right"></i></button>
                    </div>
                </div>
            </div>

            @* Stats Grid (v17_2716) *@
            <div class="v17_2716">
                <div class="stat-box-v v17_2717">
                    <span>T·ªïng Pizza ƒëang b√°n</span>
                    <h2>@pizzaCount</h2>
                </div>
                <div class="stat-box-v v17_2721">
                    <span>Combo hi·ªán c√≥</span>
                    <h2>@comboCount</h2>
                </div>
                <div class="stat-box-v v17_2725">
                    <span>S·∫£n ph·∫©m h·∫øt h√†ng</span>
                    <h2>@outCount</h2>
                </div>
            </div>
        </div>
    </main>
    </div>

    @* Cart Offcanvas *@
    <div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas">
        <div class="offcanvas-header bg-brand-orange text-white">
            <h5 class="offcanvas-title fw-black">Gi·ªè h√†ng c·ªßa b·∫°n</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body d-flex flex-column">
            <div id="cart-items-container" class="flex-grow-1 overflow-auto mb-3">
                <div class="text-center py-5">
                    <i class="bi bi-cart-x fs-1 text-brand-gray-light"></i>
                    <p class="text-brand-gray mt-2">Gi·ªè h√†ng tr·ªëng</p>
                </div>
            </div>
            <div id="cart-summary" class="border-top pt-3" style="display: none;">
                <div class="d-flex justify-content-between mb-3">
                    <span class="fw-bold">T·ªïng c·ªông:</span>
                    <span id="cart-total-price" class="fw-black text-brand-orange fs-5">0‚Ç´</span>
                </div>
                <div class="d-grid gap-2">
                    <a asp-controller="Order" asp-action="ScanQr" class="btn btn-brand-primary py-2 fw-bold">ƒê·∫∑t m√≥n ngay</a>
                    <button onclick="cart.clear()" class="btn btn-link text-brand-gray small text-decoration-none">X√≥a t·∫•t c·∫£</button>
                </div>
            </div>
        </div>
    </div>

    @* Scripts *@
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    
    <script>
        $(document).ready(function() {
            const $searchBox = $('#searchBox');
            const $catTabs = $('#catTabs .cat-tab-link');
            const $rows = $('#tableBody tr');
            const $visibleCount = $('#visibleCount');
            const $totalCount = $('#totalCount');

            $totalCount.text($rows.length);

            function filter() {
                const term = $searchBox.val().toLowerCase();
                const activeCat = $('#catTabs .cat-tab-link.active').data('cat');
                let count = 0;

                $rows.each(function() {
                    const $row = $(this);
                    const name = ($row.data('name') || "").toString().toLowerCase();
                    const cat = ($row.data('cat') || "").toString();
                    
                    const matchesSearch = name.includes(term);
                    const matchesCat = (activeCat === 'All' || cat === activeCat);

                    if (matchesSearch && matchesCat) {
                        $row.show();
                        count++;
                    } else {
                        $row.hide();
                    }
                });
                $visibleCount.text(count);
            }

            $searchBox.on('input', filter);

            $catTabs.on('click', function(e) {
                e.preventDefault();
                $catTabs.removeClass('active');
                $(this).addClass('active');
                filter();
            });

            filter();
        });
    </script>
</body>
</html>
