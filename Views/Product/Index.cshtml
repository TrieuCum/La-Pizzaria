@model LaPizzaria.ViewModels.ProductIndexViewModel
@{ ViewData["Title"] = "Qu·∫£n l√Ω M√≥n ƒÉn"; }

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800;900&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>
    :root {
        --primary-red: #da291c;
        --light-cream: #f8f5ed;
        --wood-brown: #5a2e0a;
    }
    .product-banner {
        background: #ffffff;
        background-image: 
            repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.02) 10px, rgba(0,0,0,0.02) 20px),
            url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="paper" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="20" cy="20" r="1" fill="rgba(0,0,0,0.03)"/><circle cx="80" cy="40" r="1" fill="rgba(0,0,0,0.03)"/><circle cx="40" cy="80" r="1" fill="rgba(0,0,0,0.03)"/></pattern></defs><rect width="100" height="100" fill="url(%23paper)"/></svg>');
        position: relative;
        padding: 60px 0;
        margin-bottom: 3rem;
        overflow: hidden;
    }
    .product-banner::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 20px;
        background: repeating-linear-gradient(
            90deg,
            #ff7a00 0px,
            #ff7a00 20px,
            #ffffff 20px,
            #ffffff 40px
        );
    }
    .product-title {
        font-family: 'Playfair Display', serif;
        font-weight: 900;
        font-size: clamp(36px, 6vw, 64px);
        color: #da291c;
        margin-bottom: 0.5rem;
        line-height: 1.1;
    }
    .product-subtitle {
        font-family: 'Playfair Display', serif;
        font-weight: 700;
        font-size: clamp(20px, 3vw, 28px);
        color: #5a2e0a;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .brand-card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 5px 5px rgba(0, 0, 0, 0.250);
        background: white;
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .product-item-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(218, 41, 28, 0.1) !important;
    }
    .btn-brand-primary {
        background-color: var(--primary-red);
        border-color: var(--primary-red);
        color: white;
        font-weight: bold;
        padding: 10px 24px;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    .btn-brand-primary:hover {
        background-color: var(--wood-brown);
        border-color: var(--wood-brown);
        transform: translateY(-2px);
    }
    .search-pill {
        border: 2px solid #eee;
        transition: all 0.3s ease;
    }
    .search-pill:focus {
        border-color: var(--primary-red);
        box-shadow: 0 0 0 4px rgba(218, 41, 28, 0.1);
    }
    
    /* Category List Styles */
    .brand-list-group .list-group-item {
        border: none;
        margin-bottom: 8px;
        border-radius: 8px !important;
        font-weight: 600;
        color: #666;
        transition: all 0.2s ease;
        padding: 12px 16px;
    }
    .brand-list-group .list-group-item:hover {
        background-color: #f8f5ed;
        color: var(--primary-red);
        padding-left: 20px;
    }
    .brand-list-group .list-group-item.active {
        background-color: var(--primary-red);
        color: white;
        box-shadow: 0 4px 12px rgba(218, 41, 28, 0.3);
    }
    
    /* Product Card Styles */
    .card-title {
        font-family: 'Playfair Display', serif;
        font-weight: 700;
        color: #333;
    }
    .price-tag {
        color: var(--primary-red);
        font-weight: 800;
        font-size: 1.2rem;
        font-family: 'Inter', sans-serif;
    }
    .img-wrap {
        position: relative;
        width: 100%;
        padding-top: 75%; /* 4:3 Aspect Ratio */
        background: #f8f5ed;
        overflow: hidden;
    }
    .img-wrap img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }
    .product-item-card:hover .img-wrap img {
        transform: scale(1.1);
    }
    .img-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
    }
</style>

<!-- Banner Section -->
<div class="product-banner">
    <div class="container position-relative" style="z-index: 1;">
        <div class="row align-items-center">
            <div class="col-lg-7">
                <h1 class="product-title">TH·ª∞C ƒê∆†N</h1>
                <div class="product-subtitle">
                    <span>QU·∫¢N L√ù M√ìN ƒÇN & COMBO</span>
                </div>
            </div>
            <div class="col-lg-5 text-lg-end mt-4 mt-lg-0">
                <div class="d-flex gap-2 justify-content-lg-end">
                    <a asp-action="Upsert" class="btn btn-brand-primary shadow-sm flex-grow-1 flex-lg-grow-0">
                        <i class="bi bi-plus-circle me-2"></i>Th√™m M√≥n
                    </a>
                    <a asp-action="CreateCombo" class="btn btn-outline-dark shadow-sm flex-grow-1 flex-lg-grow-0" style="padding: 10px 24px; font-weight: 600;">
                        <i class="bi bi-box-seam me-2"></i>T·∫°o Combo
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container mb-5">
    <!-- Search Bar -->
    <div class="brand-card p-4 mb-4">
        <div class="position-relative">
            <i class="bi bi-search position-absolute top-50 translate-middle-y text-muted" style="left: 15px; font-size: 1.1rem;"></i>
            <input id="searchBox" type="text" class="form-control form-control-lg search-pill ps-5" placeholder="T√¨m ki·∫øm m√≥n ƒÉn, combo...">
        </div>
    </div>

    <div class="row g-4">
        <!-- Sidebar Categories -->
        <div class="col-lg-3">
            <div class="brand-card p-3 h-100">
                <h5 class="font-weight-bold mb-3 px-2" style="font-family: 'Playfair Display', serif; color: var(--wood-brown);">Danh M·ª•c</h5>
                <div class="list-group brand-list-group" id="catList">
                    <a href="#" class="list-group-item list-group-item-action active" data-cat="All"><i class="bi bi-grid-fill me-2"></i>T·∫•t c·∫£</a>
                    <a href="#" class="list-group-item list-group-item-action" data-cat="Pizza"><i class="bi bi-disc me-2"></i>Pizza</a>
                    <a href="#" class="list-group-item list-group-item-action" data-cat="ƒê·ªì u·ªëng"><i class="bi bi-cup-straw me-2"></i>ƒê·ªì u·ªëng</a>
                    <a href="#" class="list-group-item list-group-item-action" data-cat="M√≥n ph·ª•"><i class="bi bi-basket me-2"></i>M√≥n ph·ª•</a>
                    <a href="#" class="list-group-item list-group-item-action" data-cat="Combo"><i class="bi bi-stars me-2"></i>Combo</a>
                </div>
            </div>
        </div>

        <!-- Product Grid -->
        <div class="col-lg-9">
            <div id="menuGrid" class="row row-cols-1 row-cols-sm-2 row-cols-xl-3 g-4">
                @{ var outIds = Model.OutOfStockIds ?? new List<int>(); }
                
                @* Products *@
                @foreach (var p in Model.Products)
                {
                    var isOut = outIds.Contains(p.Id);
                    <div class="col" data-cat="@p.Category" data-name="@p.Name">
                        <div class="brand-card product-item-card h-100 d-flex flex-column">
                            <div class="img-wrap">
                                @if (!string.IsNullOrEmpty(p.ImageUrl)) {
                                    <img src="@p.ImageUrl" alt="@p.Name" onerror="this.parentElement.classList.add('img-placeholder');this.remove();this.parentElement.innerText='üçï';"/>
                                } else {
                                    <div class="img-placeholder">üçï</div>
                                }
                                @if (isOut) {
                                    <div class="position-absolute top-0 end-0 m-2 badge bg-secondary">H·∫øt h√†ng</div>
                                }
                            </div>
                            <div class="card-body d-flex flex-column flex-grow-1 p-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title mb-0">@p.Name</h5>
                                </div>
                                <div class="text-muted small mb-2"><i class="bi bi-tag me-1"></i>@p.Category</div>
                                <div class="mt-auto d-flex justify-content-between align-items-center">
                                    <span class="price-tag">@p.Price.ToString("N0")‚Ç´</span>
                                    <div class="btn-group">
                                        <a asp-action="Upsert" asp-route-id="@p.Id" class="btn btn-sm btn-outline-primary" title="S·ª≠a"><i class="bi bi-pencil"></i></a>
                                        <a asp-action="Ingredients" asp-route-id="@p.Id" class="btn btn-sm btn-outline-secondary" title="Nguy√™n li·ªáu"><i class="bi bi-egg-fried"></i></a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                @* Combos *@
                @foreach (var c in Model.Combos)
                {
                    var fallbackImg = c.Items.FirstOrDefault(i => i.Product != null && !string.IsNullOrEmpty(i.Product.ImageUrl))?.Product?.ImageUrl;
                    var img = !string.IsNullOrEmpty(c.ImageUrl) ? c.ImageUrl : fallbackImg;
                    var raw = c.Items.Where(i=>i.Product!=null).Select(i => i.Product!.Price * i.MinQuantity).DefaultIfEmpty(0m).Sum();
                    var afterAmount = raw - (c.DiscountAmount > 0 ? c.DiscountAmount : 0);
                    var afterPercent = c.DiscountPercent.HasValue ? afterAmount * (1 - (c.DiscountPercent.Value/100m)) : afterAmount;
                    var comboPrice = afterPercent < 0 ? 0 : afterPercent;

                    <div class="col" data-cat="Combo" data-name="@c.Name">
                        <div class="brand-card product-item-card h-100 d-flex flex-column position-relative">
                             <div class="position-absolute top-0 start-0 m-2 badge bg-danger shadow-sm" style="z-index:2">Combo</div>
                            <div class="img-wrap">
                                @if (!string.IsNullOrEmpty(img)) {
                                    <img src="@img" alt="@c.Name" onerror="this.parentElement.classList.add('img-placeholder');this.remove();this.parentElement.innerText='üçï';"/>
                                } else {
                                    <div class="img-placeholder">üçï</div>
                                }
                            </div>
                            <div class="card-body d-flex flex-column flex-grow-1 p-3">
                                <h5 class="card-title mb-2">@c.Name</h5>
                                <div class="small text-muted mb-3 flex-grow-1" style="max-height: 3em; overflow: hidden; text-overflow: ellipsis;">
                                    @string.Join(", ", c.Items.Where(i=>i.Product!=null).Select(i => $"{i.Product!.Name} x{i.MinQuantity}"))
                                </div>
                                <div class="mt-auto d-flex justify-content-between align-items-center">
                                    <span class="price-tag text-danger">@comboPrice.ToString("N0")‚Ç´</span>
                                    <div class="btn-group">
                                        <a asp-action="EditCombo" asp-route-id="@c.Id" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></a>
                                        <form asp-action="DeleteCombo" asp-route-id="@c.Id" method="post" class="d-inline" onsubmit="return confirm('Xo√° combo n√†y?');">
                                            <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', initMenu);

async function initMenu(){
    const catList = document.getElementById('catList');
    const menuGrid = document.getElementById('menuGrid');
    const searchBox = document.getElementById('searchBox');

    function normalize(s){ return (s||'').toLowerCase(); }
    function canonicalCategory(raw){
        const s = normalize(raw);
        if (s.includes('pizza')) return 'Pizza';
        if (s.includes('u·ªëng') || s.includes('drink') || s.includes('beverage')) return 'ƒê·ªì u·ªëng';
        if (s.includes('ph·ª•') || s.includes('side')) return 'M√≥n ph·ª•';
        if (s.includes('combo')) return 'Combo';
        if (s === 'all') return 'All';
        return raw || '';
    }
    function applies(el, cat, term){
        const ec = canonicalCategory(el.getAttribute('data-cat') || '');
        const name = el.getAttribute('data-name') || '';
        const catOk = (canonicalCategory(cat) === 'All') || (ec === canonicalCategory(cat));
        const textOk = normalize(name).includes(normalize(term));
        return catOk && textOk;
    }
    function render(cat){
        const term = searchBox.value || '';
        const cards = Array.from(menuGrid.querySelectorAll('[data-cat]'));
        cards.forEach(el => {
            el.style.display = applies(el, cat, term) ? '' : 'none';
        });
    }
    catList.querySelectorAll('a').forEach(a => {
        a.addEventListener('click', (e)=>{
            e.preventDefault();
            catList.querySelectorAll('a').forEach(x=>x.classList.remove('active'));
            a.classList.add('active');
            render(a.getAttribute('data-cat'));
        });
    });
    searchBox.addEventListener('input', () => {
        const active = catList.querySelector('a.active');
        const cat = active ? active.getAttribute('data-cat') : 'All';
        render(cat);
    });
    render('All');
}
</script>
